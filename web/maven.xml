<project default="war"
  xmlns:j="jelly:core"
  xmlns:u="jelly:util"
  xmlns:x="jelly:xml"
  xmlns:ant="jelly:ant"
  xmlns:maven="jelly:maven"
  xmlns:util="jelly:util">

	<property file="build.properties" />

	<preGoal name="war:war">
		<ant:echo message="copy ${maven.build.dir}/${maven.final.name}.jar to ${maven.war.webapp.dir}/WEB-INF/lib"/>
		<ant:copy toDir="${maven.war.webapp.dir}/WEB-INF/lib" file="${maven.build.dir}/${maven.final.name}.jar"/>
	</preGoal>

	<preGoal name="war:webapp">
		<j:set var="precompileJsp" value="${maven.war.precompile}"/>
		<j:if test="${precompileJsp == 'true'}">
			<attainGoal name="precompile-jsp"/>
		</j:if>
		<j:if test="${precompileJsp != 'true'}">
			<ant:copy toDir="${maven.war.webapp.dir}">
				<ant:fileset dir="${maven.war.src}">
					<ant:include name="**/*.jsp"/>
				</ant:fileset>
			</ant:copy>
		</j:if>
	</preGoal>

	<postGoal name="war:webapp">
		<j:set var="precompileJsp" value="${maven.war.precompile}"/>
		<j:if test="${precompileJsp == 'true'}">
			<maven:get var="target" property="maven.war.webapp.dir" plugin="maven-war-plugin" />
			<util:available file="${maven.build.dir}/web-fragment.xml">
				<ant:echo message="splicing precomipled JSP servlet mappings into web.xml"/>
				<util:loadText var="fragment" file="${maven.build.dir}/web-fragment.xml"/>
				<ant:replace file="${target}/WEB-INF/web.xml" token="&lt;!-- [Auto-generated JSP servlets] --&gt;" value="${fragment}"/>
			</util:available>
		</j:if>
	</postGoal>

	<goal name="check-fail" description="Fail if unit tests failed">
		<ant:fail message="Unit tests failed." if="maven.test.failure"/>
	</goal>
	<goal name="precompile-jsp" description="Precompile all JSPs into java classes, and then into classes" prereqs="war:init">
		<maven:get var="warSource" property="maven.war.src" plugin="maven-war-plugin" />
		<maven:get var="warBuildDir" property="maven.war.webapp.dir" plugin="maven-war-plugin" />

		<j:set var="jspOutDir" value="${maven.build.dir}/jspc-source"/>
		<j:set var="jspClassesOutDir" value="${warBuildDir}/WEB-INF/classes"/>

		<ant:mkdir dir="${jspOutDir}"/>
		<ant:mkdir dir="${jspClassesOutDir}"/>

		<ant:path id="jspc.classpath">
			<ant:path refid="maven.dependency.classpath"/>
			<ant:pathelement path="${maven.build.dest}"/>
		</ant:path>
		<ant:java classname="org.apache.jasper.JspC" fork="true">
			<ant:classpath refid="maven.dependency.classpath"/>
			<ant:arg value="-d"/>
			<ant:arg value="${jspOutDir}"/>
			<ant:arg value="-webinc"/>
			<ant:arg value="${maven.build.dir}/web-fragment.xml"/>
			<ant:arg value="-uriroot"/>
			<ant:arg value="${warSource}"/>
			<ant:arg value="-p"/>
			<ant:arg value="${pom.package}.jsp"/>
		</ant:java>
		<ant:javac
			srcdir="${jspOutDir}"
			destdir="${jspClassesOutDir}"
			debug="${maven.compile.debug}"
			deprecation="${maven.compile.deprecation}"
			optimize="${maven.compile.optimize}"
			classpathref="jspc.classpath"/>
	</goal>
</project>
